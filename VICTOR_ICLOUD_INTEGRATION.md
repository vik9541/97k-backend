# Victor iCloud System Integration

## ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ Ğ’Ğ¸ĞºÑ‚Ğ¾Ñ€Ğ° Ğ›Ğ°Ğ²Ñ€ĞµĞ½Ñ‚ÑŒĞµĞ²Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        VICTOR SYSTEM ARCHITECTURE                           â”‚
â”‚                      info@97v.ru | PRIMARY_ADMIN                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   iPhone ğŸ“±     â”‚
                              â”‚   Ğ’Ğ¸ĞºÑ‚Ğ¾Ñ€Ğ°       â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                  â”‚                  â”‚
                    â–¼                  â–¼                  â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Apple iCloud    â”‚ â”‚  Telegram     â”‚ â”‚   Voice/Notes     â”‚
        â”‚   Contacts        â”‚ â”‚  @97v_bot     â”‚ â”‚                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                   â”‚                   â”‚
                  â”‚    Apple OAuth    â”‚    Webhook        â”‚  (Future)
                  â”‚                   â”‚                   â”‚
                  â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           97K BACKEND (NestJS)                              â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     VICTOR SYSTEM CONNECTOR                          â”‚   â”‚
â”‚  â”‚                  (Central Integration Hub)                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                       â”‚                        â”‚                 â”‚
â”‚         â–¼                       â–¼                        â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   Apple     â”‚        â”‚   Telegram   â”‚        â”‚   Victor iCloud  â”‚      â”‚
â”‚  â”‚   Auth      â”‚        â”‚   Bot        â”‚        â”‚   Service        â”‚      â”‚
â”‚  â”‚   Service   â”‚        â”‚   Service    â”‚        â”‚                  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                       â”‚                        â”‚                 â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                 â”‚                                          â”‚
â”‚                                 â–¼                                          â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                    â”‚     Event Emitter      â”‚                              â”‚
â”‚                    â”‚  (System Events Bus)   â”‚                              â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                 â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   PostgreSQL (Prisma)  â”‚
                    â”‚                        â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                    â”‚  â”‚     users        â”‚  â”‚
                    â”‚  â”‚     contacts     â”‚  â”‚
                    â”‚  â”‚  victor_observations â”‚
                    â”‚  â”‚  victor_daily_summaries â”‚
                    â”‚  â”‚  apple_contacts_sync â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## API Endpoints

### Apple Sign-In Integration
```
GET  /api/apple/auth        â†’ Redirect to Apple Sign-In
POST /api/apple/callback    â†’ OAuth callback (form_post)
GET  /api/apple/callback    â†’ OAuth callback (fallback)
GET  /api/apple/status      â†’ Connection status [Auth]
POST /api/apple/disconnect  â†’ Disconnect Apple [Auth]
POST /api/apple/refresh     â†’ Refresh tokens [Auth]
```

### Telegram Bot (@97v_bot)
```
POST /api/telegram/webhook   â†’ Telegram updates
GET  /api/telegram/health    â†’ Bot health check
POST /api/telegram/notify    â†’ Send notification to Victor
POST /api/telegram/set-webhook â†’ Manual webhook setup
```

### Victor System
```
GET  /api/victor/system/status    â†’ Full system status
POST /api/victor/system/sync      â†’ Initiate full sync [Auth]
GET  /api/victor/system/summary   â†’ Daily summary
POST /api/victor/system/connect/apple    â†’ Connect Apple [Auth]
POST /api/victor/system/disconnect/apple â†’ Disconnect Apple [Auth]
POST /api/victor/system/export    â†’ Export data [Auth]
POST /api/victor/system/notify    â†’ Send notification
GET  /api/victor/system/health    â†’ System health
```

### Victor iCloud Contacts (from previous implementation)
```
POST /api/victor/icloud/init    â†’ Initialize sync
POST /api/victor/icloud/sync    â†’ Sync contacts
GET  /api/victor/contacts       â†’ Get all contacts
GET  /api/victor/contacts/stats â†’ Contact statistics
GET  /api/victor/contacts/export â†’ Export contacts
```

## Telegram Bot Commands (@97v_bot)

| ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|---------|----------|
| `/start` | ĞŸÑ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ Ğ¸ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ğ¸ |
| `/help` | Ğ¡Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ¿Ğ¾ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°Ğ¼ |
| `/meeting [Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ]` | Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ²ÑÑ‚Ñ€ĞµÑ‡Ñƒ |
| `/Ğ²ÑÑ‚Ñ€ĞµÑ‡Ğ° [Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ]` | Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ²ÑÑ‚Ñ€ĞµÑ‡Ñƒ (RU) |
| `/task [Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ]` | Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ |
| `/Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° [Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ]` | Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ (RU) |
| `/idea [Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ]` | Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ¸Ğ´ĞµÑ |
| `/Ğ¸Ğ´ĞµÑ [Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ]` | Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ¸Ğ´ĞµÑ (RU) |
| `/contacts` | ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ |
| `/ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹` | ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ (RU) |
| `/sync` | Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ iCloud |
| `/ÑĞ¸Ğ½Ñ…Ñ€` | Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ (RU) |
| `/stats` | Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ |
| `/ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°` | Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° (RU) |

**Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸:**
- ğŸ“± ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ° â†’ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ
- ğŸ“ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ³ĞµĞ¾Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¸ â†’ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ¼ĞµÑÑ‚Ğ°
- ğŸ¤ Ğ“Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ â†’ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ (Ñ‚Ñ€Ğ°Ğ½ÑĞºÑ€Ğ¸Ğ¿Ñ†Ğ¸Ñ Ğ² Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ¼)

## Database Schema (Victor-specific)

### New Enums
```prisma
enum UserRole {
  CUSTOMER_B2C
  CUSTOMER_B2B
  MANAGER
  ADMIN
  PRIMARY_ADMIN  // Ğ›Ğ°Ğ²Ñ€ĞµĞ½Ñ‚ÑŒĞµĞ² Ğ’.ĞŸ. (Level 100)
}

enum ObservationType {
  MEETING     // Ğ’ÑÑ‚Ñ€ĞµÑ‡Ğ°
  TASK        // Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ°
  IDEA        // Ğ˜Ğ´ĞµÑ
  CONTACT     // ĞĞ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚
  NOTE        // Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ°
  LOCATION    // Ğ›Ğ¾ĞºĞ°Ñ†Ğ¸Ñ
  VOICE       // Ğ“Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ¾Ğµ
  REMINDER    // ĞĞ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğµ
}
```

### New Models
```prisma
model VictorObservation {
  id                BigInt
  userId            String
  type              ObservationType
  content           String
  metadata          Json?
  relatedContactIds BigInt[]
  source            String    // 'telegram', 'icloud', 'manual'
  telegramMessageId BigInt?
  aiProcessed       Boolean
  aiSummary         String?
  aiActions         Json?
  createdAt         DateTime
  processedAt       DateTime?
}

model VictorDailySummary {
  id               BigInt
  userId           String
  date             DateTime
  contactsTotal    Int
  contactsNew      Int
  observationsTotal Int
  meetingsCount    Int
  tasksCompleted   Int
  tasksPending     Int
  summary          String?
  highlights       Json?
  appleSynced      Boolean
}
```

### User Model Extensions
```prisma
model User {
  // ... existing fields
  name        String?   // Full name
  appleUserId String?   @unique  // Apple Sign-In ID
  isVerified  Boolean   @default(false)
  appleContactsSync AppleContactsSync?
}
```

## Environment Variables

```env
# Apple Sign-In
APPLE_CLIENT_ID=ru.97v.contacts
APPLE_TEAM_ID=YOUR_TEAM_ID
APPLE_KEY_ID=YOUR_KEY_ID
APPLE_PRIVATE_KEY=-----BEGIN PRIVATE KEY-----...
APPLE_REDIRECT_URI=https://api.97v.ru/api/apple/callback

# Telegram Bot
TELEGRAM_BOT_TOKEN=your_bot_token_from_botfather
TELEGRAM_WEBHOOK_URL=https://api.97v.ru/api/telegram/webhook
VICTOR_TELEGRAM_ID=victor_telegram_numeric_id
```

## Data Flow

### 1. Apple Sign-In Flow
```
Victor opens 97v.ru
       â”‚
       â–¼
GET /api/apple/auth
       â”‚
       â–¼
Redirect to Apple Sign-In
       â”‚
       â–¼
User authorizes app
       â”‚
       â–¼
POST /api/apple/callback (code, state, user)
       â”‚
       â–¼
Exchange code for tokens
       â”‚
       â–¼
Create/Update Victor user
       â”‚
       â–¼
Save Apple credentials
       â”‚
       â–¼
Redirect to success page
```

### 2. Telegram Bot Flow
```
Victor sends message to @97v_bot
       â”‚
       â–¼
Telegram sends webhook to /api/telegram/webhook
       â”‚
       â–¼
TelegramBotService.handleUpdate()
       â”‚
       â”œâ”€ Command? â†’ handleCommand()
       â”‚              â”œâ”€ /meeting â†’ saveObservation(MEETING)
       â”‚              â”œâ”€ /task â†’ saveObservation(TASK)
       â”‚              â”œâ”€ /idea â†’ saveObservation(IDEA)
       â”‚              â””â”€ /sync â†’ initializeFullSync()
       â”‚
       â”œâ”€ Contact? â†’ handleContactShare() â†’ prisma.contact.create()
       â”‚
       â”œâ”€ Location? â†’ handleLocationShare() â†’ saveObservation(LOCATION)
       â”‚
       â””â”€ Text? â†’ saveObservation(NOTE)
```

### 3. System Sync Flow
```
POST /api/victor/system/sync
       â”‚
       â–¼
VictorSystemConnector.initializeFullSync()
       â”‚
       â”œâ”€ Validate Apple token
       â”‚       â”‚
       â”‚       â–¼
       â”‚  Sync iCloud contacts
       â”‚
       â”œâ”€ Check Telegram status
       â”‚
       â””â”€ Emit 'sync.completed' event
              â”‚
              â–¼
        Notify Victor via Telegram
```

## Testing

```bash
# Run all integration tests
npm run test -- --testPathPattern="integrations"

# Run specific test suites
npm run test -- --testPathPattern="apple"
npm run test -- --testPathPattern="telegram"
npm run test -- --testPathPattern="system"

# Current test count: 38 tests passing
```

## Security Considerations

1. **Apple Sign-In**: Uses ES256 signed JWT for client_secret
2. **Telegram Bot**: Only responds to Victor (verified by VICTOR_TELEGRAM_ID)
3. **API Endpoints**: Protected by JwtAuthGuard where needed
4. **Password**: Auto-generated for Apple Sign-In users (not used)

## Next Steps

1. **Phase 14**: Calendar integration (Apple Calendar)
2. **Phase 15**: Reminders integration
3. **Voice transcription**: Whisper API integration
4. **AI Agents**: Process observations with 3 AI agents
5. **Real-time sync**: WebSocket notifications for contact changes

---

**Owner**: Ğ›Ğ°Ğ²Ñ€ĞµĞ½Ñ‚ÑŒĞµĞ² Ğ’Ğ¸ĞºÑ‚Ğ¾Ñ€ ĞŸĞµÑ‚Ñ€Ğ¾Ğ²Ğ¸Ñ‡  
**Email**: info@97v.ru  
**Role**: PRIMARY_ADMIN (Level 100)  
**Telegram**: @97v_bot
